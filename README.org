#+TITLE: GNU Emacs Config
#+AUTHOR: Mark Mandriota
#+STARTUP: showeverything

* Prerequisites
- Fish UNIX Shell (optional)
- Git
- GNU Aspell

** Fonts
- Fira Code (optional)
- Georgia (optional)

* Basic Environment Variables
#+begin_src emacs-lisp :results silent
(setenv "LDFLAGS" "-L/opt/homebrew/opt/openssl@3/lib")
(setenv "CFLAGS" "-I/opt/homebrew/opt/openssl@3/include")

(add-to-list 'exec-path "/opt/homebrew/bin")
(add-to-list 'exec-path "/usr/local/bin")
(add-to-list 'exec-path "~/.cargo/bin")
(add-to-list 'exec-path "~/go/bin")

(setenv "PATH"
		(concat
		 (mapconcat #'identity exec-path path-separator)
		 "/opt/homebrew/opt/llvm@14/bin" path-separator
		 "~/.emacs.d/bin" path-separator
		 "/opt/local/bin" path-separator
		 "/opt/local/sbin" path-separator
		 "/opt/homebrew/sbin" path-separator
		 "/System/Cryptexes/App/usr/bin" path-separator
		 "/usr/bin" path-separator
		 "/bin" path-separator
		 "/usr/sbin" path-separator
		 "/sbin" path-separator
		 "/usr/local/go/bin" path-separator
		 "/Library/TeX/Distributions/Programs/texbin"))
#+end_src

* Basic Debug
Print start-up time:
#+begin_src emacs-lisp :results silent
(add-hook 'after-init-hook (lambda () (message (emacs-init-time))))
#+end_src

* Basic Appearance
** General Window Appearance
#+begin_src emacs-lisp :results silent
(scroll-bar-mode -1)
(set-fringe-mode 5)
(tool-bar-mode -1)
(tooltip-mode -1)

(unless (eq system-type 'darwin)
  (menu-bar-mode -1))
#+end_src

** Cursor
#+begin_src emacs-lisp :results silent
(setq-default cursor-type 'box)
(blink-cursor-mode -1)
#+end_src

** Set Font (Fira Code Retina)
#+begin_src emacs-lisp :results silent
(defun user/try-set-face-attribute (font height)
  (if (null (x-list-fonts font))
	  (message (format "Failed to locate font '%s'" font))
	(set-face-attribute 'default nil :font font :height height)))

(user/try-set-face-attribute "Fira Code Retina" 135)
#+end_src

* Basic Settings
#+begin_src emacs-lisp :results silent
(global-auto-revert-mode 1)
(save-place-mode 1)
(recentf-mode 1)

(setq inhibit-startup-screen t
	  use-dialog-box nil)
#+end_src

* Basic Shell
** Set Shell Path
Try to set fish shell as a default shell. Fish is a smart and user-friendly shell:
#+begin_src emacs-lisp :results silent
(let ((sh-path "/opt/homebrew/bin/fish"))
  (if (file-exists-p sh-path)
	  (setq-default explicit-shell-file-name sh-path)
	(message "fish shell not found")))
#+end_src

* Basic Keybindings
#+begin_src emacs-lisp :results silent
(setq ns-alternate-modifier 'meta
	  ns-right-alternate-modifier 'none)
#+end_src

* Basic Windowing
#+begin_src emacs-lisp :results silent
(when (fboundp 'windmove-default-keybindings)
  (windmove-default-keybindings 'control))

(global-set-key (kbd "M-3") 'enlarge-window)
(global-set-key (kbd "M-2") 'enlarge-window-horizontally)
#+end_src

* Basic Text Editing
#+begin_src emacs-lisp :results silent
(setq visible-bell t)
(setq-default tab-width 4)

(setq-default fill-column 90)
#+end_src

* Basic Org Mode
#+begin_src emacs-lisp :results silent
(setq org-startup-indented t
	  org-confirm-babel-evaluate nil
	  org-edit-src-content-indentation 0
	  org-src-tab-acts-natively t
	  org-src-preserve-indentation t
	  org-image-actual-width nil)

(defun user/indent-org-block ()
  (interactive)
  (when (org-in-src-block-p)
    (org-edit-special)
    (indent-region (point-min) (point-max))
    (org-edit-src-exit)))

(define-key org-mode-map (kbd "TAB") #'user/indent-org-block)
#+end_src

* Basic Spell check
#+begin_src emacs-lisp :results silent
(setq ispell-program-name "aspell") 
(setq ispell-list-command "list")
#+end_src

* Basic Tree Sitter
#+begin_src emacs-lisp :results silent
(setq treesit-language-source-alist
	  '((bash "https://github.com/tree-sitter/tree-sitter-bash")
		(c "https://github.com/tree-sitter/tree-sitter-c")
		(cmake "https://github.com/uyha/tree-sitter-cmake")
		(common-lisp "https://github.com/theHamsta/tree-sitter-commonlisp")
		(cpp "https://github.com/tree-sitter/tree-sitter-cpp")
		(css "https://github.com/tree-sitter/tree-sitter-css")
		(csharp "https://github.com/tree-sitter/tree-sitter-c-sharp")
		(elisp "https://github.com/Wilfred/tree-sitter-elisp")
		(go "https://github.com/tree-sitter/tree-sitter-go")
		(go-mod "https://github.com/camdencheek/tree-sitter-go-mod")
		(html "https://github.com/tree-sitter/tree-sitter-html")
		(js . ("https://github.com/tree-sitter/tree-sitter-javascript" "master" "src"))
		(json "https://github.com/tree-sitter/tree-sitter-json")
		(lua "https://github.com/Azganoth/tree-sitter-lua")
		(make "https://github.com/alemuller/tree-sitter-make")
		(markdown "https://github.com/ikatyang/tree-sitter-markdown")
		(python "https://github.com/tree-sitter/tree-sitter-python")
		(r "https://github.com/r-lib/tree-sitter-r")
		(rust "https://github.com/tree-sitter/tree-sitter-rust")
		(toml "https://github.com/tree-sitter/tree-sitter-toml")
		(tsx . ("https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src"))
		(typescript . ("https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src"))
		(typst "https://github.com/uben0/tree-sitter-typst")
		(yaml "https://github.com/ikatyang/tree-sitter-yaml")))
#+end_src

* Package Manager
Bootstrap straight. Straight is an overengineered package manager:
#+begin_src emacs-lisp :results silent
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 6))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))
#+end_src

Always ensure that packages are installed:
#+begin_src emacs-lisp :results silent
(setq use-package-always-ensure t)
#+end_src

Why it works?:
#+begin_src emacs-lisp :results silent
(use-package straight
  :custom
  (straight-use-package-by-default t))
#+end_src

* All The Icons
#+begin_src emacs-lisp :results silent
(use-package all-the-icons
  :if (display-graphic-p))
#+end_src

** All The Icons Dired
#+begin_src emacs-lisp :results silent
(use-package all-the-icons-dired
  :if (display-graphic-p)
  :straight (:type git :host github :repo "jtbm37/all-the-icons-dired")
  :config
  (add-hook 'dired-mode-hook 'all-the-icons-dired-mode))
#+end_src

** All The Icons Ivy Rich
#+begin_src emacs-lisp :results silent
(use-package all-the-icons-ivy-rich
  :after ivy-rich
  :init (all-the-icons-ivy-rich-mode 1))
#+end_src

* Theme
#+begin_src emacs-lisp :results silent
(use-package doom-themes
  :config
  (setq doom-themes-enable-bold t
		doom-themes-enable-italic t)
  (load-theme 'doom-nord t)

  (doom-themes-visual-bell-config)
  (doom-themes-org-config))
#+end_src

* Projectile
#+begin_src emacs-lisp :results silent
(use-package projectile
  :config
  (projectile-mode +1)
  (define-key projectile-mode-map (kbd "M-p") 'projectile-command-map))
#+end_src

* Dashboard
#+begin_src emacs-lisp :results silent
(use-package dashboard
  :config
  (setq dashboard-items '((recents  . 7)
                          (projects . 4)
                          (agenda . 4)
                          (registers . 4)))
  (setq dashboard-icon-type 'all-the-icons)
  ;; (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (dashboard-setup-startup-hook))
#+end_src

* Text Editing
#+begin_src emacs-lisp :results silent
(use-package whole-line-or-region
  :config (whole-line-or-region-global-mode))
#+end_src

** God Mode
#+begin_src emacs-lisp :results silent
(use-package god-mode)

(global-set-key (kbd "<escape>") #'god-mode-all)

(defun user/god-mode-update-cursor ()
  (if (or god-local-mode buffer-read-only)
	  (set-cursor-color "cyan")
	(set-cursor-color "white")))

(add-hook 'post-command-hook #'user/god-mode-update-cursor)
#+end_src

** Elgrep
#+begin_src emacs-lisp :results silent
(use-package elgrep)
#+end_src

** Multiple cursors
#+begin_src emacs-lisp :results silent
(use-package multiple-cursors)

(global-set-key (kbd "C-S-c C-S-c") 'mc/edit-lines)
(global-set-key (kbd "C->") 'mc/mark-next-like-this)
(global-set-key (kbd "C-<") 'mc/mark-previous-like-this)
(global-set-key (kbd "C-c C-<") 'mc/mark-all-like-this)
(global-set-key (kbd "C-S-<mouse-1>") 'mc/add-cursor-on-click)
#+end_src

** Insert Kaomoji
#+begin_src emacs-lisp :results silent
(use-package insert-kaomoji)

(global-set-key (kbd "C-S-k") #'insert-kaomoji)
#+end_src

* Which Key Mode
#+begin_src emacs-lisp :results silent
(use-package which-key
  :config
  (which-key-mode))
#+end_src

* Ivy
#+begin_src emacs-lisp :results silent
(use-package ivy
  :config
  (ivy-mode))
#+end_src

** Counsel
#+begin_src emacs-lisp :results silent
(use-package counsel
  :config (counsel-mode))
#+end_src

** Ivy Rich
#+begin_src emacs-lisp :results silent
(use-package ivy-rich
  :config
  (ivy-rich-mode 1)
  (setcdr (assq t ivy-format-functions-alist) #'ivy-format-function-line))
#+end_src

* Magit
#+begin_src emacs-lisp :results silent
(use-package magit)
#+end_src

* LSP Mode
#+begin_src emacs-lisp :results silent
(use-package go-mode
  :mode "\\.go\\'")
(use-package rustic
  :mode ("\\.rs\\'" . rustic-mode)
  :config
  (setq rustic-format-on-save t))
(use-package fish-mode)
;; (use-package racket-mode)
(use-package geiser-guile)
(use-package lsp-mode
  :hook ((lsp-mode . lsp-enable-which-key-integration)
		 ;; (racket-mode . lsp)
		 (geiser-guil . lsp)
		 (elisp-mode . lsp)
		 (go-mode . lsp)
		 (rustic . lsp)
		 (c-mode . lsp))
  :commands lsp)

(use-package lsp-ui :commands lsp-ui-mode)
#+end_src

** Company Mode
#+begin_src emacs-lisp :results silent
(use-package company
  :config
  (add-hook 'after-init-hook 'global-company-mode)
  (setq company-idle-delay 0
		company-minimum-prefix-length 1
		company-selection-wrap-around t)
  (company-tng-configure-default))
#+end_src

* Typst Mode
Readable LaTeX:
#+begin_src emacs-lisp :results silent
(use-package typst-ts-mode
  :straight (:type git :host sourcehut :repo "meow_king/typst-ts-mode")
  :custom
  (typst-ts-mode-watch-options "--open"))
#+end_src

* Messengers
** Telegram
#+begin_src emacs-lisp :results silent
(use-package telega
  :commands (telega)
  :defer t)

(add-hook 'telega-load-hook 'telega-notifications-mode)
(use-package language-detection)
(define-key global-map (kbd "C-c t") telega-prefix-map)
#+end_src

* Readers
** Nov
EPUB reader:
#+begin_src emacs-lisp :results silent
(use-package nov
  :config
  (let ((font "Georgia"))
	(defun user/nov-font-setup ()
	  (face-remap-add-relative 'variable-pitch :family font
                               :height 1.2))
	(if (null (x-list-fonts font))
		(message (format "Failed to locate font '%s'" font))
	  (add-hook 'nov-mode-hook 'user/nov-font-setup)))

  (setq nov-text-width t)
  (setq visual-fill-column-center-text t)
  
  (add-hook 'nov-mode-hook 'visual-line-mode)
  (add-hook 'nov-mode-hook 'visual-fill-column-mode)
  
  (add-to-list 'auto-mode-alist '("\\.epub\\'" . nov-mode)))
#+end_src

* Start Server
#+begin_src emacs-lisp :results silent
(server-start)
#+end_src
